
	<!-- get environment vars -->
	<property environment="env"/>
	<property name="debug" value="on"/>
	<property name="inca.test" value="0"/>
	<property name="testworkingdir" value="${basedir}"/>

	<!-- project build targets -->
	<property name="build.lib" value="${basedir}/lib"/>
	<property name="build.bin" value="${basedir}/bin"/>
	<property name="build.sbin" value="${basedir}/sbin"/>
	<property name="build.src" value="${basedir}/src"/>
	<property name="build.etc" value="${basedir}/etc"/>
	<property name="build.etc.common" value="${basedir}/etc/common"/>
	<property name="build.classes" value="${basedir}/classes"/>
	<property name="build.docs" value="${basedir}/docs"/>
	<property name="build.javadoc" 
            value="${build.docs}/javadocs/${package.name}"/>
	<property name="build.tlddoc" value="${build.docs}/tlddocs"/>
	<property name="build.tests" value="${basedir}/tests"/>
	<property name="tests.output" value="${basedir}/test-results"/>
	<property name="build.output" value="${basedir}"/>
	<property name="build.dependencyfile" value="${basedir}/Dependencies"/>

  <available property="tldsExist" file="${basedir}/webapps" />

	<!-- =================================================================== -->
	<!-- Clover setup                                                        -->
	<!-- =================================================================== -->
	<property name="clover.lib.location" value="${env.CLOVER_HOME}/lib/clover.jar"/>

	<path id="clover.lib">
		<pathelement location="${clover.lib.location}"/>
	</path>

	<available file="${clover.lib.location}" property="have.clover"/>

	<target name="define-clover" if="have.clover">
		<taskdef resource="cloverlib.xml" classpathref="clover.lib" />
	</target>

	<!-- =================================================================== -->
	<!-- Sets the CLASSPATH                                                  -->
	<!-- The default here is to include all jar files in the lib dir and the -->
	<!-- local etc directory as well as the system classpath                 -->
	<!-- =================================================================== -->
	<path id="classpath">
		<pathelement location="${build.classes}"/>
		<fileset dir="${build.lib}">
			<exclude name="*.LICENSE"/>
			<include name="*.jar"/>
		</fileset>
		<fileset file="${jar.name}.jar"/>
		<pathelement location="${build.etc}"/>
		<pathelement location="${build.etc.common}"/>
		<pathelement path="${java.class.path}"/>
	</path>

	<!-- =================================================================== -->
	<!-- Create binary distribution                                          -->
	<!-- =================================================================== -->
	<target name="bindist" depends="javadoc"
		description="creates a binary distribution of this component">

    <!-- set version.minor if not set in file -->
    <property file="${basedir}/version" prefix="versionfile"/>
    <property name="tmpdir" value="installdir-bindist"/>
		<property name="tarname" value="${package.name}-${versionfile.version}-bin.tar.gz"/>

    <delete dir="${tmpdir}"/>
    <delete file="${tarname}"/>
    <antcall target="install">
       <param name="installdir" value="${tmpdir}"/>
    </antcall>
		<tar destfile="${tarname}" compression="gzip">
			<tarfileset dir="${tmpdir}"> 
				<exclude name="*bin"/>
				<exclude name="*bin/*"/>
				<exclude name="lib/inca-common.jar" unless="isIncaCommon"/>
				<exclude name="lib/incaXmlBeans.jar" unless="isIncaCommon"/>
			</tarfileset>
			<tarfileset dir="${tmpdir}" mode="755">
				<include name="*bin"/>
				<include name="*bin/*"/>
			</tarfileset>
		</tar>
    <delete dir="${tmpdir}"/>
	</target>

	<!-- =================================================================== -->
	<!-- clean up Clover output                                              -->
	<!-- =================================================================== -->
	<target name="clean-clover" if="have.clover" depends="define-clover">
		<clover-clean/>
	</target>

	<!-- =================================================================== -->
	<!-- clean up down to a base devel snapshot                              -->
	<!-- =================================================================== -->
	<target name="clean" depends="clean-clover" description="clean up any files generated by build">
		<delete quiet="true" includeEmptyDirs="true">
			<fileset dir="${tests.output}"/>
			<fileset dir="classes"/>
			<fileset file="junitReport.xml"/>
			<fileset dir="${basedir}/src" includes="**/*_jsp.*"/>
			<fileset dir="${basedir}/src" includes="**/*_tag.*"/>
		</delete>

	</target>

	<!-- =================================================================== -->
	<!-- compile                                                             -->
	<!-- =================================================================== -->
	<target name="compile" 
		description="Compiles all of the source code">

		<mkdir dir="${build.classes}"/>
		<javac
			srcdir="${build.src}"
			destdir="${build.classes}"
			classpathref="classpath"
			debug="${debug}">
		</javac>
		<copy toDir="${build.classes}">
			<fileset dir="${build.src}">
				<include name="**/*.properties"/>
				<include name="**/*.html"/>
				<include name="**/*.xml"/>
			</fileset>
		</copy>
    <copy toDir="${build.classes}">
      <fileset dir="${build.lib}">
        <include name="*.tar.gz"/>
      </fileset>
    </copy>
    <copy toDir="${build.classes}" failOnError="false">
      <fileset dir="${build.sbin}">
        <include name="*"/>
      </fileset>
    </copy>
  </target>

	<!-- =================================================================== -->
	<!-- clean up everything but the svn files                               -->
	<!-- =================================================================== -->
	<target name="devel-clean" depends="clean"
		description="clean up all files that do not belong in svn">
		<delete quiet="true">
			<fileset file="${jar.name}.jar"/>
		</delete>
		<delete quiet="true">
			<fileset dir="${basedir}">
				<include name="test.*"/>
			</fileset>
		</delete>
		<delete quiet="true" includeEmptyDirs="true" >
			<fileset dir="${build.lib}"/>
		</delete>
		<delete quiet="true" includeEmptyDirs="true">
			<fileset dir="${build.docs}"/>
		</delete>
		<delete quiet="true" includeEmptyDirs="true">
			<fileset dir="${basedir}">
				<include name="${package.name}.*tar*"/>
			</fileset>
		</delete>

	</target>

	<!-- =================================================================== -->
	<!-- Print detailed usage information                                    -->
	<!-- =================================================================== -->
	<target name="devel-help" depends="help"
		description="shows help about developer specific targets">
		<echo message="bindist            Create a binary distribution"/>
		<echo message="devel-clean        Removes all file created by dist"/>
		<echo message="release            Marks this version as stable in svn"/>
		<echo message="release-candidate  Tag this as a release"/>
		<echo message="run-tests          Builds and runs the JUnit tests."/>
		<echo message="                   Requires extra setup:"/>
		<echo message="                   junit jar must be in $ANT_HOME/lib"/>
		<echo message="srcdist            Create a source distribution"/>
	</target>

	<!-- =================================================================== -->
	<!-- Generate UML diagrams                                               -->
	<!-- =================================================================== -->
	<target name="diag" description="generates the Inca Util Javadocs">
		<javadoc
			sourcepath="${build.src}"
			classpathref="classpath"
			doclet="UmlGraph"
			docletpathref="classpath"
			additionalparam="-all -qualify">
			<fileset dir="${build.src}">
				<exclude name="**/*Test.java"/>
				<exclude name="**/*.xml"/>
				<exclude name="**/*.properties"/>
			</fileset>
		</javadoc>
	</target>

	<!-- =================================================================== -->
	<!-- Print usage information                                             -->
	<!-- =================================================================== -->
	<target name="help" description="shows help about useful targets">
		<echo message="Target             Description"/>
		<echo message="------------------------------------------------------"/>
		<echo message="install            Install"/>
		<echo message="compile            Compiles Depot source code"/>
		<echo message="javadoc            Creates only Javadoc API"/>
		<echo message="jar                Creates the ${jar.name}.jar file"/>
		<echo message="war                Creates the ${jar.name}.war file if applicable"/>
		<echo message="devel-help         List the targets available only to "/>
		<echo message="                   developers."/>
	</target>

	<!-- =================================================================== -->
	<!-- Install project into a directory                                    -->
	<!-- =================================================================== -->
	<target name="install"
		description="install to a specified location" depends="jar">
		<fail unless="installdir"
			message="USAGE: ant -Dinstalldir=path install"/>
		<copy todir="${installdir}/etc" failonerror="false">
			<fileset dir="${basedir}/etc"/>
		</copy>
		<copy todir="${installdir}/lib" failonerror="true">
			<fileset dir="${basedir}/lib">
			</fileset>
		</copy>
		<copy todir="${installdir}/bin" failonerror="true">
			<fileset dir="${basedir}/bin">
			</fileset>
		</copy>
		<copy todir="${installdir}/docs" failonerror="true">
			<fileset dir="${basedir}/docs">
			</fileset>
		</copy>
		<copy todir="${installdir}/sbin" failonerror="false">
			<fileset dir="${basedir}/sbin">
			</fileset>
		</copy>
		<copy todir="${installdir}/webapps" failonerror="false">
			<fileset dir="${basedir}/webapps"/>
		</copy>
		<copy todir="${installdir}/xsl" failonerror="false">
			<fileset dir="${basedir}/xsl"/>
		</copy>
    <chmod perm="755" failonerror="true">
      <fileset dir="${installdir}/bin"/>
    </chmod>
		<copy tofile="${installdir}/etc/${package.name}-version" failonerror="true">
			<fileset file="${basedir}/version">
			</fileset>
		</copy>
		<copy todir="${installdir}/lib" failonerror="true">
			<fileset file="${basedir}/${jar.name}.jar">
			</fileset>
		</copy>

	</target>

	<!-- =================================================================== -->
	<!-- create the jar                                                      -->
	<!-- =================================================================== -->
	<target name="jar" description="create jar of project src" depends="compile">
    <antcall target="jsp"/> 
		<jar
			destfile="${jar.name}.jar"
			basedir="${build.classes}">
		</jar>
	</target>

	<!-- =================================================================== -->
	<!-- Generate JavaDoc                                                    -->
	<!-- =================================================================== -->
	<target name="javadoc" description="generates the Javadocs" depends="tlddoc">
		<mkdir dir="${build.docs}"/>
		<mkdir dir="${build.javadoc}"/>
		<javadoc
			sourcepath="${build.src}"
			destdir="${build.javadoc}"
			classpathref="classpath"
			packagenames="edu.sdsc.inca.*"/>
	</target>

	<target name="tlddoc" description="generates the TLD docs" if="tldsExist">
		<mkdir dir="${build.docs}"/>
		<mkdir dir="${build.tlddoc}"/>
    <java fork="true" jar="${build.lib}/tlddoc.jar" failonerror="false">
        <arg line="-d ${build.tlddoc}"/>
        <arg value="${basedir}/webapps/inca/WEB-INF/tags/inca"/>
    </java>
	</target>

	<!-- =================================================================== -->
	<!-- Clover targets                                                      -->
	<!-- =================================================================== -->
	<target name="with-clover" depends="define-clover">
		<fail unless="have.clover" message="Could not find Clover library"/>
		<clover-setup/>
	</target>

	<target name="clover-html" depends="define-clover">
		<clover-html-report outdir="coverage_html" title="Inca"/>
	</target>

	<target name="clover-pdf" depends="define-clover">
		<clover-pdf-report outfile="coverage.pdf"/>
	</target>

	<target name="clover-log" depends="define-clover">
		<clover-log/>
	</target>

	<target name="clover-xml" depends="define-clover">
		<clover-report>
			<current outfile="coverage.xml">
				<format type="xml"/>
			</current>
		</clover-report>
	</target>

	<!-- =================================================================== -->
	<!-- run the ant tests                                                   -->
	<!-- =================================================================== -->
	<target name="run-tests"
		description="run the unit tests included in this package">
		<mkdir dir="${tests.output}"/>

		<junit printsummary="yes" fork="yes" timeout="3600000" showoutput="no"
           haltonfailure="true">
      <jvmarg value="-Djava.awt.headless=true"/>
			<sysproperty key="inca.test" value="${inca.test}"/>
			<classpath>
				<path refid="clover.lib" />
				<path refid="classpath" />
			</classpath>
			<formatter type="xml"/>
			<batchtest todir="${tests.output}">
				<fileset dir="${build.src}">
					<include name="**/*Test.java"/>
					<exclude name="**/PersistentTest.java"/>
				</fileset>
			</batchtest>
		</junit>

		<junitreport toFile="junitReport.xml">
			<fileset dir="${tests.output}">
			</fileset>
		</junitreport>

	</target>

	<!-- =================================================================== -->
	<!-- create jsp source files -->
	<!-- =================================================================== -->
	<target name="jsp" description="compile jsp pages" if="war.name">
    <property name="webapp" value="${basedir}/webapps/inca"/>
    <delete>
      <fileset dir="${basedir}/src" includes="**/*_jsp.*" />
    </delete>
    <antcall target="compile"/> 
    <taskdef classname="org.apache.jasper.JspC" name="jasper2" 
             classpathref="classpath"/>
    <jasper2 verbose="0" package="${jsp.package}" uriroot="${webapp}" 
             webXmlFragment="generated_web.xml" outputDir="src" 
             compilerTargetVM="1.8" compilerSourceVM="1.8" />
    <antcall target="compile"/> 
    <loadfile property="web" srcFile="${basedir}/generated_web.xml"/>
    <copy file="${webapp}/WEB-INF/web.template.xml"
          tofile="${webapp}/WEB-INF/web.xml" overwrite="true" />
    <replace file="${webapp}/WEB-INF/web.xml" token="@@@" value="${web}" />
    <copy file="${webapp}/WEB-INF/web.template.xml"
          tofile="${webapp}/WEB-INF/web.dyn.xml" overwrite="true" />
    <replace file="${webapp}/WEB-INF/web.dyn.xml" token="@@@" value="" />
    <!-- <delete file="${basedir}/generated_web.xml"/> -->
	</target>

	<!-- =================================================================== -->
	<!-- Create source distribution                                          -->
	<!-- =================================================================== -->
	<target name="srcdist"
          depends="javadoc"
		      description="creates a source distribution of this component" >

    <property file="${basedir}/version" prefix="versionfile"/>
    <!-- set version.minor if not set in file -->
		<property name="tmpdir" value="installdir-srcdist"/>
		<property name="prefix" value="${package.name}-${versionfile.version}"/>
		<property name="tarname" value="${prefix}-src.tar.gz"/>

    <delete dir="${tmpdir}"/>
    <delete file="${tarname}"/>
		<tar destfile="${tarname}" compression="gzip">
			<tarfileset dir="${basedir}" prefix="${prefix}">
				<exclude name="*bin"/>
				<exclude name="*bin/*"/>
				<exclude name="Dependencies"/>
			</tarfileset>
			<tarfileset dir="${basedir}" prefix="${prefix}" mode="755">
				<include name="*bin"/>
				<include name="*bin/*"/>
			</tarfileset>
		</tar>
    <delete dir="${tmpdir}"/>
	</target>

	<!-- =================================================================== -->
	<!-- create the a war file -->
	<!-- =================================================================== -->
	<target name="war" description="create a war file if applicable to project" 
          if="war.name" depends="jar">
		<delete file="webapps/${war.name}.war"/>
    <mkdir dir="webapps"/>
		<war destfile="webapps/${war.name}.war"
         webxml="${basedir}/webapps/inca/WEB-INF/web.xml">
      <fileset dir="webapps/inca"/> 
			<lib file="inca-consumers.jar"/>
			<lib dir="${basedir}/lib">
        <include name="batik*"/>
        <include name="cewolf*"/>
        <include name="jfreechart*"/>
        <include name="jcommon*"/>
      </lib>
		</war>
		<war destfile="webapps/root.war" 
         webxml="${basedir}/webapps/root/WEB-INF/web.xml">
      <fileset dir="webapps/root"/>
    </war>
	</target>

